name: Makefile CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Prepare Ansible configuration for testing
      run: |
        make
        echo 'Appending secret to inventory/hosts'
        echo "${{ secrets.TEST_HOST }} # Test Host supplied by secrets in GitHub Actions" >>inventory/hosts
        cat inventory/hosts

    - name: Setting up SSH key
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > private_key.pem
        chmod 600 private_key.pem
        
    - name: Run Ansible Playbook
      run: |
        sudo apt update
        sudo apt install -y ansible
        ansible-playbook -i inventory playbooks/setup.yml --private-key=private_key.pem --user=${{ secrets.REMOTE_USER }}
    # Shout-outs to John Otieno
    # https://linuxhint.com/github-action-ansible/

    #- name: Run check
    #  run: make check

    #- name: Run distcheck
    #  run: make distcheck
